<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ - ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏ô‡πá‡∏Ñ‡∏ö‡∏∏‡∏Ñ</title>
    <meta name="description" content="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏ô‡πá‡∏Ñ‡∏ö‡∏∏‡∏Ñ">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">
                    üìö ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                </h1>
                <button onclick="logout()" 
                        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Status Messages -->
        <div id="statusMessage" class="hidden mb-6 p-4 rounded-lg"></div>

        <!-- Profile Information -->
        <div class="bg-white rounded-xl shadow-xl p-8 mb-8 fade-in">
            <div class="flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8 mb-8">
                <!-- Profile Image -->
                <div class="flex-shrink-0">
                    <div id="currentImageContainer">
                        <img id="currentProfileImage" src="" alt="Profile" 
                             class="w-32 h-32 object-cover rounded-full border-4 border-blue-200 hidden">
                        <div id="defaultAvatar" 
                             class="w-32 h-32 bg-gray-300 rounded-full flex items-center justify-center text-gray-600 text-4xl font-bold">
                            ?
                        </div>
                    </div>
                </div>

                <!-- User Info -->
                <div class="flex-1 text-center md:text-left">
                    <h2 id="userFullName" class="text-3xl font-bold text-gray-800 mb-2"></h2>
                    <p id="userPosition" class="text-lg text-gray-600 mb-2"></p>
                    <p id="userDepartment" class="text-gray-600 mb-2"></p>
                    <p id="userStudentId" class="text-sm text-gray-500 mb-2"></p>
                    <div class="flex flex-col md:flex-row md:space-x-4 text-sm text-gray-500">
                        <p id="userEmail"></p>
                        <p id="userPhone"></p>
                    </div>
                    <p id="userStatus" class="text-sm font-medium mt-2"></p>
                </div>
            </div>

            <!-- Edit Button -->
            <div class="text-center">
                <button onclick="toggleEditMode()" id="editToggleBtn"
                        class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                    ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>
            </div>
        </div>

        <!-- Admin Panel (Hidden by default, shown if user is admin) -->
        <div id="adminPanel" class="bg-white rounded-xl shadow-xl p-8 mb-8 hidden fade-in">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">‡πÅ‡∏ú‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3>
            <div class="flex flex-col sm:flex-row gap-4">
                <a href="device_management.html"
                   class="flex-1 bg-purple-600 text-white py-3 px-6 rounded-lg hover:bg-purple-700 transition duration-200 font-medium flex items-center justify-center">
                    <span class="mr-2">üíª</span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
                </a>
                <!-- Add other admin links here if needed -->
            </div>
        </div>

        <!-- Edit Form (Hidden by default) -->
        <div id="editForm" class="bg-white rounded-xl shadow-xl p-8 hidden fade-in">
            <h3 class="text-2xl font-semibold text-gray-800 mb-6">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
            
            <form id="profileForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠ *</label>
                        <select id="titlePrefix" name="titlePrefix" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠</option>
                            <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                            <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
                            <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                        </select>
                    </div>

                    <!-- ‡∏ä‡∏∑‡πà‡∏≠ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠ *</label>
                        <input type="text" id="firstName" name="firstName" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                    </div>

                    <!-- ‡∏™‡∏Å‡∏∏‡∏• -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏Å‡∏∏‡∏• *</label>
                        <input type="text" id="lastName" name="lastName" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                    </div>

                    <!-- ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á *</label>
                        <select id="position" name="position" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
                            <option value="‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå">‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</option>
                            <option value="‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                        </select>
                    </div>

                    <!-- ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤ -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤ *</label>
                        <select id="department" name="department" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤</option>
                            <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
                            <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</option>
                            <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•">‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</option>
                            <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à">‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</option>
                            <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
                            <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£">‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</option>
                            <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå‡πÅ‡∏•‡∏∞‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®">‡∏™‡∏≤‡∏Ç‡∏≤‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå‡πÅ‡∏•‡∏∞‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</option>
                            <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>
                        </select>
                    </div>

                    <!-- ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤/‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤/‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á *</label>
                        <input type="text" id="studentId" name="studentId" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                    </div>

                    <!-- ‡∏≠‡∏µ‡πÄ‡∏°‡∏• -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏• *</label>
                        <input type="email" id="email" name="email" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                    </div>

                    <!-- ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ *</label>
                        <input type="text" id="phone" name="phone" required 
                               placeholder="0898555668"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                    </div>

                    <!-- ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
                        <div class="flex items-center space-x-4">
                            <input type="file" id="profileImage" name="profileImage" accept="image/*"
                                   class="hidden" onchange="previewImage(this)">
                            <button type="button" onclick="document.getElementById('profileImage').click()"
                                    class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-200">
                                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà
                            </button>
                            <div id="imagePreview" class="hidden">
                                <img id="previewImg" src="" alt="Preview" class="w-20 h-20 object-cover rounded-lg border">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 pt-6">
                    <button type="submit" id="saveBtn"
                            class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 transition duration-200 font-medium flex items-center justify-center">
                        <span id="saveText">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</span>
                        <div id="saveSpinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                    <button type="button" onclick="cancelEdit()"
                            class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 transition duration-200 font-medium">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </form>
        </div>

        <!-- My Borrow/Return History -->
        <div id="borrowHistoryContainer" class="bg-white rounded-xl shadow-xl p-8 mt-8 fade-in">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-300 rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-100 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">
                            <th class="py-3 px-6 border-b">Record ID</th>
                            <th class="py-3 px-6 border-b">Device Name</th>
                            <th class="py-3 px-6 border-b">Borrow Date</th>
                            <th class="py-3 px-6 border-b">Due Date</th>
                            <th class="py-3 px-6 border-b">Return Date</th>
                            <th class="py-3 px-6 border-b">Status</th>
                            <th class="py-3 px-6 border-b">Notes</th>
                        </tr>
                    </thead>
                    <tbody id="borrowHistoryTableBody">
                        <!-- Borrow history rows will be injected here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <p id="noBorrowHistoryMessage" class="text-center text-gray-500 mt-4 hidden">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</p>
        </div>
    </div>

    <script>
        // Configuration - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Google Apps Script URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxoH-lO6Nu6-u4v5JfwHRyeE6BjvxcPVkzn-tU0PjfJgD1mR_kPczYzIXjoaViMC0az/exec';
        
        let currentUser = null;
        let isEditMode = false;
        let currentUserStatus = null; // New variable to store user's status

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('token');
            const userDataString = localStorage.getItem('userData');

            if (!token || !userDataString) {
                window.location.href = 'login.html';
                return;
            }

            try {
                currentUser = JSON.parse(userDataString);
                currentUserStatus = currentUser.userStatus; // Set currentUserStatus
                displayUserProfile(currentUser);
                fetchBorrowHistory(currentUser.id);
                updateUIBasedOnPermissions(); // Call to update UI based on permissions
            } catch (e) {
                console.error("Error parsing user data from localStorage:", e);
                showStatus('error', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                logout();
                return;
            }
        });

        // Display user information
        function displayUserInfo() {
            if (!currentUser) return;

            document.getElementById('userFullName').textContent = `${currentUser.titlePrefix || ''}${currentUser.firstName} ${currentUser.lastName}`;
            document.getElementById('userPosition').textContent = currentUser.position;
            document.getElementById('userDepartment').textContent = currentUser.department;
            document.getElementById('userStudentId').textContent = `ID: ${currentUser.studentId}`;
            document.getElementById('userEmail').textContent = `Email: ${currentUser.email}`;
            document.getElementById('userPhone').textContent = `Phone: ${currentUser.phoneNumber || '-'}`;
            document.getElementById('userStatus').textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${currentUser.userStatus}`;

            const currentProfileImage = document.getElementById('currentProfileImage');
            const defaultAvatar = document.getElementById('defaultAvatar');
            if (currentUser.profilePictureUrl) {
                currentProfileImage.src = currentUser.profilePictureUrl;
                currentProfileImage.classList.remove('hidden');
                defaultAvatar.classList.add('hidden');
            } else {
                currentProfileImage.classList.add('hidden');
                defaultAvatar.classList.remove('hidden');
                defaultAvatar.textContent = currentUser.firstName ? currentUser.firstName.charAt(0).toUpperCase() : '?';
            }
        }

        // Toggle edit mode
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const editForm = document.getElementById('editForm');
            const editToggleBtn = document.getElementById('editToggleBtn');

            if (isEditMode) {
                editForm.classList.remove('hidden');
                editToggleBtn.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
                populateEditForm(currentUser);
                editForm.scrollIntoView({ behavior: 'smooth' });
            } else {
                editForm.classList.add('hidden');
                editToggleBtn.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                document.getElementById('profileForm').reset(); // Reset form when cancelling
            }
        }

        function updateUIBasedOnPermissions() {
            const adminPanel = document.getElementById('adminPanel');
            if (currentUserStatus === '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö') {
                adminPanel.classList.remove('hidden');
            } else {
                adminPanel.classList.add('hidden');
            }
        }

        // Fill edit form with current user data
        function fillEditForm() {
            if (!currentUser) return;

            document.getElementById('titlePrefix').value = currentUser.titlePrefix || '';
            document.getElementById('firstName').value = currentUser.firstName || '';
            document.getElementById('lastName').value = currentUser.lastName || '';
            document.getElementById('position').value = currentUser.position || '';
            document.getElementById('department').value = currentUser.department || '';
            document.getElementById('studentId').value = currentUser.studentId || '';
            document.getElementById('email').value = currentUser.email || '';
            document.getElementById('phone').value = currentUser.phone || '';
        }

        // Cancel edit
        function cancelEdit() {
            isEditMode = false;
            const editForm = document.getElementById('editForm');
            const editToggleBtn = document.getElementById('editToggleBtn');

            editForm.classList.add('hidden');
            editToggleBtn.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            editToggleBtn.className = 'bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium';

            // Reset form
            document.getElementById('profileForm').reset();
            document.getElementById('imagePreview').classList.add('hidden');
        }

        // Handle profile update
        async function handleUpdate(e) {
            e.preventDefault();
            
            const saveBtn = document.getElementById('saveBtn');
            const saveText = document.getElementById('saveText');
            const saveSpinner = document.getElementById('saveSpinner');
            
            // Show loading state
            saveBtn.disabled = true;
            saveText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            saveSpinner.classList.remove('hidden');
            
            try {
                const formData = new FormData(e.target);
                const userData = {};
                
                // Get form data
                for (let [key, value] of formData.entries()) {
                    if (key !== 'profileImage') {
                        userData[key] = value;
                    }
                }
                
                // Handle image upload
                const imageFile = document.getElementById('profileImage').files[0];
                if (imageFile) {
                    const base64 = await fileToBase64(imageFile);
                    userData.profileImage = base64;
                    userData.fileName = imageFile.name;
                    userData.mimeType = imageFile.type;
                }
                
                // Add action and user ID
                userData.action = 'update';
                userData.id = currentUser.id;
                userData.userStatus = currentUser.userStatus; // Keep current status
                
                // Send data
                const params = new URLSearchParams(userData);
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: params,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                
                let result;
                try {
                    const text = await response.text();
                    result = JSON.parse(text);
                } catch (parseError) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
                }
                
                if (result.success) {
                    // Update current user data
                    Object.assign(currentUser, userData);
                    if (imageFile && userData.profileImage) {
                        // Note: We don't have the new image URL from the response
                        // In a real implementation, the server should return the new image URL
                        // For now, we'll refresh the user data
                        await refreshUserData();
                    }
                    
                    // Update localStorage
                    localStorage.setItem('userData', JSON.stringify(currentUser));
                    
                    showStatus('success', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    displayUserInfo();
                    cancelEdit();
                    
                } else {
                    throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                }
                
            } catch (error) {
                console.error('Update error:', error);
                showStatus('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } finally {
                // Reset button state
                saveBtn.disabled = false;
                saveText.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á';
                saveSpinner.classList.add('hidden');
            }
        }

        // Refresh user data from server
        async function refreshUserData() {
            try {
                const response = await fetch(SCRIPT_URL + `?action=read&id=${currentUser.id}`);
                const result = JSON.parse(await response.text());
                
                if (result.success && result.data.length > 0) {
                    currentUser = result.data[0];
                    localStorage.setItem('userData', JSON.stringify(currentUser));
                }
            } catch (error) {
                console.error('Error refreshing user data:', error);
            }
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Preview image
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('userData');
            window.location.href = 'login.html';
        }

        // Show status message
        function showStatus(type, message) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `mb-6 p-4 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'}`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }

        async function fetchUserBorrowRecords() {
            try {
                const params = new URLSearchParams({
                    action: 'readBorrowRecords',
                    userId: currentUser.id,
                    token: localStorage.getItem('token')
                });

                const response = await fetch(SCRIPT_URL + '?' + params.toString(), {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    console.log('User Borrow Records:', result.data);
                    renderBorrowRecordsTable(result.data);
                } else {
                    showStatus('error', result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ');
                }
            } catch (error) {
                console.error('Error fetching user borrow records:', error);
                showStatus('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô: ' + error.message);
            }
        }

        function renderBorrowRecordsTable(records) {
            const tableBody = document.getElementById('borrowHistoryTableBody');
            const noRecordsMessage = document.getElementById('noBorrowHistoryMessage');
            tableBody.innerHTML = ''; // Clear existing rows

            if (records && records.length > 0) {
                noRecordsMessage.classList.add('hidden');
                let tableRowsHtml = '';
                records.forEach(record => {
                    tableRowsHtml += `
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-6 border-b border-gray-200 text-sm">${record.recordId}</td>
                            <td class="py-3 px-6 border-b border-gray-200 text-sm">${record.deviceName || 'N/A'}</td> <!-- Device Name will need to be fetched -->
                            <td class="py-3 px-6 border-b border-gray-200 text-sm">${new Date(record.borrowDate).toLocaleDateString()}</td>
                            <td class="py-3 px-6 border-b border-gray-200 text-sm">${new Date(record.dueDate).toLocaleDateString()}</td>
                            <td class="py-3 px-6 border-b border-gray-200 text-sm">${record.returnDate ? new Date(record.returnDate).toLocaleDateString() : '-'}</td>
                            <td class="py-3 px-6 border-b border-gray-200 text-sm">${record.borrowStatus}</td>
                            <td class="py-3 px-6 border-b border-gray-200 text-sm">${record.borrowerNotes || '-'}</td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = tableRowsHtml;
            } else {
                noRecordsMessage.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
