<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô - ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏ô‡πá‡∏Ñ‡∏ö‡∏∏‡∏Ñ</title>
    <meta name="description" content="‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°‡∏Ñ‡∏∑‡∏ô‡πÇ‡∏ô‡πá‡∏Ñ‡∏ö‡∏∏‡∏Ñ">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen py-8">
    <div class="container mx-auto px-4 max-w-2xl">
        <!-- Back to Home -->
        <div class="text-center mb-4">
            <a href="index.html" class="text-blue-600 hover:text-blue-700 text-sm">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
        </div>

        <!-- Registration Form -->
        <div class="bg-white rounded-xl shadow-2xl p-8 fade-in">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="bg-green-500 text-white rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                    <span class="text-2xl">üìù</span>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</h1>
                <p class="text-gray-600 mt-2">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö</p>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage" class="hidden mb-6 p-4 rounded-lg"></div>

            <!-- Registration Form -->
            <div id="registrationFormContainer">
                <form id="registrationForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠ *</label>
                            <select id="titlePrefix" name="titlePrefix" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠</option>
                                <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                                <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
                                <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                            </select>
                        </div>

                        <!-- ‡∏ä‡∏∑‡πà‡∏≠ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠ *</label>
                            <input type="text" id="firstName" name="firstName" required
                                   placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                        </div>

                        <!-- ‡∏™‡∏Å‡∏∏‡∏• -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏Å‡∏∏‡∏• *</label>
                            <input type="text" id="lastName" name="lastName" required
                                   placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                        </div>

                        <!-- ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á *</label>
                            <select id="position" name="position" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option>
                                <option value="‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå">‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</option>
                                <option value="‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                            </select>
                        </div>

                        <!-- ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤ -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤ *</label>
                            <select id="department" name="department" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤</option>
                                <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</option>
                                <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</option>
                                <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•">‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•</option>
                                <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à">‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à</option>
                                <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
                                <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£">‡∏™‡∏≤‡∏Ç‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</option>
                                <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå‡πÅ‡∏•‡∏∞‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®">‡∏™‡∏≤‡∏Ç‡∏≤‡πÇ‡∏•‡∏à‡∏¥‡∏™‡∏ï‡∏¥‡∏Å‡∏™‡πå‡πÅ‡∏•‡∏∞‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</option>
                                <option value="‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>
                            </select>
                        </div>

                        <!-- ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤/‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤/‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á *</label>
                            <input type="text" id="studentId" name="studentId" required
                                   placeholder="‡πÄ‡∏ä‡πà‡∏ô 66123456789"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                        </div>

                        <!-- ‡∏≠‡∏µ‡πÄ‡∏°‡∏• -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏• *</label>
                            <input type="email" id="email" name="email" required
                                   placeholder="example@email.com"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                        </div>

                        <!-- ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ *</label>
                            <input type="text" id="phone" name="phone" required 
                                   placeholder="0898555668"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-500 focus:border-transparent transition duration-200">
                        </div>

                        <!-- ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
                            <div class="flex items-center space-x-4">
                                <input type="file" id="profileImage" name="profileImage" accept="image/*"
                                       class="hidden" onchange="previewImage(this)">
                                <button type="button" onclick="document.getElementById('profileImage').click()"
                                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-200">
                                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                                </button>
                                <div id="imagePreview" class="hidden">
                                    <img id="previewImg" src="" alt="Preview" class="w-20 h-20 object-cover rounded-lg border">
                                </div>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå JPG, PNG ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB</p>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="submitBtn"
                            class="w-full bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 transition duration-200 font-medium flex items-center justify-center">
                        <span id="submitText">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</span>
                        <div id="submitSpinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                </form>
            </div>

            <!-- OTP Verification Form (hidden by default) -->
            <div id="otpVerificationContainer" class="hidden space-y-6">
                <p class="text-center text-gray-700 mb-4">‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™ OTP ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™ OTP *</label>
                    <input type="text" id="otpInput" required
                           placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ OTP 6 ‡∏´‡∏•‡∏±‡∏Å"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
                </div>
                <button type="button" id="verifyOtpBtn"
                        class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-200 font-medium flex items-center justify-center">
                    <span id="verifyOtpText">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™ OTP</span>
                    <div id="verifyOtpSpinner" class="loading-spinner ml-2 hidden"></div>
                </button>
                <div class="text-center mt-4">
                    <p class="text-gray-600">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™?</p>
                    <button type="button" id="resendOtpBtn" class="text-blue-600 hover:text-blue-700 font-medium mt-2">
                        ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™ OTP ‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
            </div>

            <!-- Login Link -->
            <div class="text-center mt-6">
                <p class="text-gray-600">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß?</p>
                <a href="login.html" class="text-blue-600 hover:text-blue-700 font-medium">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</a>
            </div>
        </div>
    </div>

    <script>
        // Configuration - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Google Apps Script URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxoH-lO6Nu6-u4v5JfwHRyeE6BjvxcPVkzn-tU0PjfJgD1mR_kPczYzIXjoaViMC0az/exec';

        let registrationData = {}; // Global variable to store registration form data temporarily

        // Function to display status messages
        function showStatus(type, message) {
            const statusMessageDiv = document.getElementById('statusMessage');
            statusMessageDiv.textContent = message;
            statusMessageDiv.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            
            if (type === 'success') {
                statusMessageDiv.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                statusMessageDiv.classList.add('bg-red-100', 'text-red-800');
            }
            statusMessageDiv.classList.remove('hidden');
            statusMessageDiv.classList.add('fade-in');

            // Optionally hide message after a few seconds
            setTimeout(() => {
                statusMessageDiv.classList.add('hidden');
            }, 5000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if already logged in
            const userData = localStorage.getItem('userData');
            if (userData) {
                window.location.href = 'profile.html';
                return;
            }

            // Form submission for registration
            document.getElementById('registrationForm').addEventListener('submit', handleRegistration);
            // Form submission for OTP verification
            document.getElementById('verifyOtpBtn').addEventListener('click', handleOtpVerification);
            // Resend OTP button
            document.getElementById('resendOtpBtn').addEventListener('click', resendOtp);
        });

        // Handle registration (Send OTP)
        async function handleRegistration(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitSpinner = document.getElementById('submitSpinner');
            
            // Show loading state
            submitBtn.disabled = true;
            submitText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á OTP...';
            submitSpinner.classList.remove('hidden');
            showStatus('', ''); // Clear previous messages
            
            try {
                const formData = new FormData(e.target);
                const userData = {};
                
                // Get form data
                for (let [key, value] of formData.entries()) {
                    if (key !== 'profileImage') {
                        userData[key] = value;
                    }
                }
                
                // Handle image upload (store temporarily, will send with final registration)
                const imageFile = document.getElementById('profileImage').files[0];
                if (imageFile) {
                    // Check file size (5MB limit)
                    if (imageFile.size > 5 * 1024 * 1024) {
                        throw new Error('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB');
                    }
                    
                    // Convert image to base64 for sending to Apps Script
                    const reader = new FileReader();
                    reader.readAsDataURL(imageFile);
                    await new Promise((resolve) => {
                        reader.onload = () => {
                            userData.profileImage = reader.result;
                            resolve();
                        };
                    });
                } else {
                    userData.profileImage = ''; // No image selected
                }

                // Validate required fields (basic client-side check before sending to server)
                const requiredFields = ['titlePrefix', 'firstName', 'lastName', 'position', 'department', 'studentId', 'email', 'phone'];
                for (const field of requiredFields) {
                    if (!userData[field]) {
                        throw new Error(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${document.querySelector(`[name="${field}"]`).previousElementSibling.textContent.replace(' *', '')} ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);
                    }
                }

                // Store registration data globally
                registrationData = userData;

                // Send OTP request (registration will happen after OTP verification)
                const params = new URLSearchParams({
                    action: 'sendOtp',
                    email: userData.email // Send OTP to this email
                });
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: params,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                
                let result;
                try {
                    const text = await response.text();
                    result = JSON.parse(text);
                } catch (parseError) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ (‡∏™‡πà‡∏á OTP)');
                }
                
                if (result.success) {
                    showStatus('success', result.message || '‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™ OTP ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
                    document.getElementById('registrationFormContainer').classList.add('hidden');
                    document.getElementById('otpVerificationContainer').classList.remove('hidden');
                    document.getElementById('otpInput').focus();
                    
                } else {
                    throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á OTP');
                }
                
            } catch (error) {
                console.error('Registration (OTP Send) error:', error);
                showStatus('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitText.textContent = '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
                submitSpinner.classList.add('hidden');
            }
        }

        // Handle OTP verification and final registration
        async function handleOtpVerification() {
            const otpInput = document.getElementById('otpInput');
            const otp = otpInput.value.trim();
            const verifyOtpBtn = document.getElementById('verifyOtpBtn');
            const verifyOtpText = document.getElementById('verifyOtpText');
            const verifyOtpSpinner = document.getElementById('verifyOtpSpinner');

            if (!otp) {
                showStatus('error', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ OTP');
                return;
            }

            // Show loading state
            verifyOtpBtn.disabled = true;
            verifyOtpText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...';
            verifyOtpSpinner.classList.remove('hidden');
            showStatus('', ''); // Clear previous messages

            try {
                // Verify OTP first
                const verifyParams = new URLSearchParams({
                    action: 'verifyOtp',
                    email: registrationData.email,
                    otp: otp
                });

                const verifyResponse = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: verifyParams,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                let verifyResult;
                try {
                    const text = await verifyResponse.text();
                    verifyResult = JSON.parse(text);
                } catch (parseError) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ (‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô OTP)');
                }

                if (!verifyResult.success) {
                    throw new Error(verifyResult.error || '‡∏£‡∏´‡∏±‡∏™ OTP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏ö');
                }

                // If OTP is valid, proceed with actual registration
                const registerParams = new URLSearchParams({
                    action: 'createUser',
                    data: JSON.stringify(registrationData)
                });

                const registerResponse = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: registerParams,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                let registerResult;
                try {
                    const text = await registerResponse.text();
                    registerResult = JSON.parse(text);
                } catch (parseError) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ (‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)');
                }

                if (registerResult.success) {
                    showStatus('success', registerResult.message || '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...');
                    localStorage.setItem('token', registerResult.token); // Store the token from registration
                    localStorage.setItem('userData', JSON.stringify(registerResult.user));
                    
                    // Clear temporary registration data
                    registrationData = {};
                    
                    setTimeout(() => {
                        window.location.href = 'profile.html';
                    }, 1500);
                } else {
                    throw new Error(registerResult.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô');
                }

            } catch (error) {
                console.error('OTP Verification / Registration error:', error);
                showStatus('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } finally {
                // Reset button state
                verifyOtpBtn.disabled = false;
                verifyOtpText.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™ OTP';
                verifyOtpSpinner.classList.add('hidden');
            }
        }

        // Resend OTP
        async function resendOtp() {
            const resendOtpBtn = document.getElementById('resendOtpBtn');
            resendOtpBtn.disabled = true;
            showStatus('', ''); // Clear previous messages

            try {
                if (!registrationData.email) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á OTP ‡∏ã‡πâ‡∏≥');
                }

                const params = new URLSearchParams({
                    action: 'sendOtp',
                    email: registrationData.email
                });

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: params,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });

                let result;
                try {
                    const text = await response.text();
                    result = JSON.parse(text);
                } catch (parseError) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ (‡∏™‡πà‡∏á OTP ‡∏ã‡πâ‡∏≥)');
                }

                if (result.success) {
                    showStatus('success', result.message || '‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™ OTP ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
                } else {
                    throw new Error(result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á OTP ‡∏ã‡πâ‡∏≥');
                }
            } catch (error) {
                console.error('Resend OTP error:', error);
                showStatus('error', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            } finally {
                resendOtpBtn.disabled = false;
            }
        }

        // Image Preview
        function previewImage(input) {
            const imagePreviewDiv = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');

            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    imagePreviewDiv.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                previewImg.src = '';
                imagePreviewDiv.classList.add('hidden');
            }
        }
    </script>
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <div id="g_id_onload"
         data-client_id="662702539784-01d43aftm8nfgevd4rn4gjagf3iqm3mh.apps.googleusercontent.com"
         data-callback="handleCredentialResponse">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
    <script>
    function handleCredentialResponse(response) {
      fetch('https://script.google.com/macros/s/AKfycbxoH-lO6Nu6-u4v5JfwHRyeE6BjvxcPVkzn-tU0PjfJgD1mR_kPczYzIXjoaViMC0az/exec', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id_token: response.credential })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          localStorage.setItem('userData', JSON.stringify(data.user));
          window.location.href = 'profile.html';
        } else {
          alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (data.error || ''));
        }
      });
    }
    </script>
</body>
</html>
